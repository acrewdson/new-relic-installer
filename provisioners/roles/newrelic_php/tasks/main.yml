---
# tasks file for newrelic_php

- name: install rpm
  yum: name=rpm
  sudo: yes

- name: use rpm to get new relic yum repo
  shell: rpm -Uvh http://yum.newrelic.com/pub/newrelic/el5/x86_64/newrelic-repo-5-3.noarch.rpm
  sudo: yes
  ignore_errors: yes

- name: yum install newrelic php agent
  yum: name=newrelic-php5
  sudo: yes

- name: configure a php agent
  shell: export NR_INSTALL_SILENT=true; /usr/bin/newrelic-install install
  sudo: yes
  notify:
    - restart apache

- name: modify php newrelic.ini license
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.license =" line="newrelic.license = {{newrelic_license_key}}"
  sudo: yes

- name: modify php newrelic.ini app name
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.appname =" line="newrelic.appname = {{application_name}}"
  sudo: yes

- name: modify php newrelic.ini high security on
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.high_security =" line="newrelic.high_security = 1"
  sudo: yes

- name: modify php newrelic.error_collector
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.error_collector.record_database_errors =" line="newrelic.error_collector.record_database_errors = false"
  sudo: yes

- name: modify php newrelic.error_collector.record_database_errors
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.error_collector.record_database_errors =" line="newrelic.error_collector.record_database_errors = false"
  sudo: yes

- name: modify php newrelic.daemon.auditlog
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.daemon.auditlog =" line="newrelic.daemon.auditlog = /var/log/newrelic/audit.log"
  sudo: yes

- name: modify php newrelic.analytics_events.capture_attributes
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.analytics_events.capture_attributes =" line="newrelic.analytics_events.capture_attributes = true"
  sudo: yes

- name: modify php newrelic.ini logfile
  lineinfile: dest={{newrelic_ini_file}} state=present regexp="newrelic.logfile =" line="newrelic.logfile = {{newrelic_agentlog_file}}"
  sudo: yes
  notify:
    - restart apache
